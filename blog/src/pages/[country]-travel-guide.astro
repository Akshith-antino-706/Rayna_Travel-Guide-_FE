---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { CITIES } from '../../scripts/cities';
import { SITE_URL } from '../utils/constants';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // Map each post's city → canonical country name from CITIES
  const cityToCountry = new Map(
    CITIES.map(c => [c.name, c.country])
  );

  // Unique countries that actually have content
  const countriesWithContent = [
    ...new Set(
      allPosts
        .map(p => cityToCountry.get(p.data.city))
        .filter(Boolean) as string[]
    ),
  ];

  return countriesWithContent.map(countryName => {
    const countrySlug = countryName.toLowerCase().replace(/\s+/g, '-');
    const countryCities = CITIES.filter(c => c.country === countryName);
    const citiesWithContent = countryCities.filter(c =>
      allPosts.some(p => p.data.city === c.name)
    );
    const countryPosts = allPosts.filter(p =>
      cityToCountry.get(p.data.city) === countryName
    );

    return {
      params: { country: countrySlug },
      props: {
        countryName,
        countrySlug,
        citiesWithContent,
        posts: countryPosts,
      },
    };
  });
}

const { countryName, countrySlug, citiesWithContent, posts } = Astro.props;

// Sort posts newest first
const sortedPosts = [...posts].sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Group posts by city
const postsByCity = citiesWithContent.map(city => ({
  city,
  posts: sortedPosts.filter(p => p.data.city === city.name),
})).filter(g => g.posts.length > 0);

// Hero image from most popular city (most posts)
const heroCityData = postsByCity.sort((a, b) => b.posts.length - a.posts.length)[0];
const heroImage = heroCityData
  ? `https://images.unsplash.com/${heroCityData.city.unsplashId}?w=1600&h=600&fit=crop&q=80`
  : 'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=1600&h=600&fit=crop&q=80';

// Continent for the country
const continent = CITIES.find(c => c.country === countryName)?.continent ?? '';

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'TravelGuide',
  name: `${countryName} Travel Guide`,
  description: `Explore ${countryName} with ${posts.length} expert travel articles covering ${citiesWithContent.map(c => c.name).join(', ')}.`,
  about: { '@type': 'Country', name: countryName },
  author: { '@type': 'Organization', name: 'TravelScope' },
};

const breadcrumbLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE_URL },
    { '@type': 'ListItem', position: 2, name: 'Country Guides', item: SITE_URL },
    { '@type': 'ListItem', position: 3, name: `${countryName} Travel Guide` },
  ],
};
---

<BaseLayout
  title={`${countryName} Travel Guide – Cities, Tips & Essentials`}
  description={`Your complete guide to ${countryName}. Explore ${posts.length} expert articles covering ${citiesWithContent.map(c => c.name).join(', ')} and more.`}
  jsonLd={jsonLd}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />

  <!-- Breadcrumb -->
  <div class="bg-gray-50 border-b border-gray-100">
    <div class="container-wide py-3">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span class="sep">/</span>
        <span class="text-gray-500">Country Guides</span>
        <span class="sep">/</span>
        <span class="text-gray-600">{countryName}</span>
      </nav>
    </div>
  </div>

  <!-- Hero -->
  <section class="relative h-[300px] md:h-[380px]">
    <div class="absolute inset-0 overflow-hidden">
      <img
        src={heroImage}
        alt={countryName}
        class="w-full h-full object-cover"
        loading="eager"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-black/75 via-black/40 to-black/10"></div>
    </div>
    <div class="container-wide relative h-full flex flex-col justify-end pb-10 px-4">
      <p class="text-white/60 text-sm font-medium uppercase tracking-widest mb-2">{continent} · Country Guide</p>
      <h1 class="text-white text-3xl md:text-5xl font-bold leading-tight mb-3">{countryName}</h1>
      <div class="flex items-center gap-6 text-white/70 text-sm">
        <span>{posts.length} articles</span>
        <span>·</span>
        <span>{citiesWithContent.length} {citiesWithContent.length === 1 ? 'city' : 'cities'}</span>
      </div>
    </div>
  </section>

  <!-- City Guides -->
  {citiesWithContent.length > 0 && (
    <section class="py-10 bg-white">
      <div class="container-wide">
        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">
          Cities in {countryName}
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
          {citiesWithContent.map(city => {
            const count = sortedPosts.filter(p => p.data.city === city.name).length;
            return (
              <a
                href={`/${city.slug}-travel-guide`}
                class="group relative rounded-2xl overflow-hidden aspect-[4/5]"
              >
                <img
                  src={`https://images.unsplash.com/${city.unsplashId}?w=400&h=500&fit=crop&q=70`}
                  alt={city.name}
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                <div class="absolute bottom-4 left-4 right-4">
                  <h3 class="text-white font-bold text-base leading-snug">{city.name}</h3>
                  <p class="text-white/60 text-xs mt-0.5">{count} articles</p>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- Posts by City -->
  {postsByCity.map((group, index) => (
    <section class:list={['py-10', index % 2 === 0 ? 'bg-gray-50' : 'bg-white']}>
      <div class="container-wide">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">{group.city.name}</h2>
          <a
            href={`/${group.city.slug}-travel-guide`}
            class="text-sm text-gray-500 hover:text-gray-900 transition-colors"
          >
            Full guide →
          </a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-5">
          {group.posts.slice(0, 8).map(post => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.slug}
              city={post.data.city}
              category={post.data.category}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              readingTime={post.data.readingTime}
            />
          ))}
        </div>
      </div>
    </section>
  ))}

  <!-- CTA -->
  <section class="py-12 bg-gradient-to-br from-gray-900 to-black">
    <div class="container-narrow text-center text-white">
      <h2 class="text-2xl sm:text-3xl font-bold mb-4">
        Plan Your {countryName} Trip
      </h2>
      <p class="text-gray-300 mb-8 max-w-xl mx-auto">
        Browse all our {countryName} travel articles for tips, itineraries, visa guides, and more.
      </p>
      <a
        href="/"
        class="bg-white text-gray-900 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition-colors"
      >
        Explore All Articles
      </a>
    </div>
  </section>
</BaseLayout>
